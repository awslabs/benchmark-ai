version: 0.2

phases:
  install:
    commands:
    # kubernetes 1.14 is a part of the base image - no need to install it here
      - conda create --yes -c conda-forge -p /opt/deploy awscli
      - export PATH=/opt/deploy/bin:$PATH
  pre_build:
    commands:
      - aws eks update-kubeconfig --kubeconfig /tmp/kubeconfig --name benchmark-cluster
      - export KUBECONFIG=/tmp/kubeconfig
  build:
    commands:
      - ls
      - |
        if [ -f "deploy.yml" ] && [ $(stat --printf="%s" deploy.yml) -gt 0 ]; then
          cat deploy.yml
          kubectl apply -f deploy.yml
        elif [ -f "deploy/kustomization.yml" ]; then
          kubectl apply -k deploy
        else
          echo "Nothing to deploy"
        fi
