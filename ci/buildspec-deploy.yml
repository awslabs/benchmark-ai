version: 0.2

phases:
  build:
    commands:
      - env
      - export KUBECONFIG=${CODEBUILD_SRC_DIR_infra_output}/kubeconfig
      - cd ${PROJECT_NAME}
      - if [ "${PROJECT_NAME}" = "bai-bff" ]; then export VERSION=$(cat bin/anubis | grep VERSION= | cut -d \" -f2); fi
      - make deploy STAGE=prod COMMIT_SHORT_HASH=${CODEBUILD_RESOLVED_SOURCE_VERSION} DOCKER_REGISTRY=${DOCKER_REGISTRY}
  post_build:
    commands:
      - if [ -z "$CODEBUILD_BUILD_SUCCEEDING" ]; then echo "Build failing, no need to create placeholder service_endpoint"; else touch ./service_endpoint; fi
artifacts:
  files:
    - ${PROJECT_NAME}/service_endpoint
