#!/usr/bin/env bash

conda_usage() {
    printf "

 Anubis Setup uses Conda to provide a predictable running environment.
 Make sure you have Conda installed. We recommend installing miniconda
 via https://docs.conda.io/en/latest/miniconda.html

 Once Conda is installed run the following:

 %s --env-setup

 And then re-run the ${0##*/} command :-)

" "${0##*/}"
    exit 9
}

_which_conda() {
    if [[ -n "${CONDA_EXE}" ]] && [[ -f "${CONDA_EXE}" ]]; then
        echo "${CONDA_EXE}"
        return 0
    fi

    if [[ -f $(which conda) ]]; then
        echo $(which conda)
        return 0
    fi

    if [[ -f $(type conda) ]]; then
        echo $(type conda)
        return 0
    fi
}

CONDA_EXE="${CONDA_EXE:-$(_which_conda)}"

env_setup() {
    if ! "${CONDA_EXE}" --version; then conda_usage; fi;
    local tmp_environment_file=$(mktemp "/tmp/${0##*/}-XXXXXXXXX").yml
    ((DEBUG)) && echo "${tmp_environment_file}"
    cat <<EOF > "${tmp_environment_file}"
name: anubis-setup
channels:
  - conda-forge
  - defaults
dependencies:
  - sed 4.7
  - terraform 0.12.*
  - python 3.7.*
  - boto3
  - requests
  - pip
  - pip:
    - pyfiglet
EOF
    cmd="${CONDA_EXE} env update -f ${tmp_environment_file}"
    ${cmd}
    rm "${tmp_environment_file}"
    [ -f "${tmp_environment_file%.*}" ] && rm "${tmp_environment_file%.*}"

    printf "
  Please proceed with your %s shenanigans

" "${0##*/}"
}

if [ "${1}" == "--env-setup" ]; then
    env_setup
    exit $?
fi

if ! source "${CONDA_EXE%/*}"/activate anubis-setup >& /dev/null; then
    printf "
  Oops, there seems to be a problem with Conda...
        (Co you have Conda installed? Is it in your \$PATH?)\n"
    conda_usage
fi

DEBUG=${DEBUG:-0}
VERBOSE=${VERBOSE:-0}
_t=$(realpath "${BASH_SOURCE}")
ANUBIS_REPO_HOME=${ANUBIS_REPO_HOME:="${_t%/*}"}
unset _t

## put code here

#TODO
#Manual setup, (pipeline free)
# ci/baictl create infra --aws-prefix-list-id=pl-f8a64391 --aws-region=us-west-2
# build-and-deploy-all-services

#Pipeline setup
# ci/anubis-pipeline.py --region=us-west-1

main() {
    while [ -n "${1}" ]; do
        local unshift=0
        case "${1}" in
            --whoami)
                shift
                ;;
            *)
                shift
                echo "Unknown flag ${1}"
                ;;
        esac
        ((!unshift)) && shift
    done

    (cd ${ANUBIS_REPO_HOME}/ci; ./anubis-driver.py $@)
}

main $@
