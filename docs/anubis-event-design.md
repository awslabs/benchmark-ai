# Anubis: Event design

This document describes each of the main events that are pushed through the Benchmark AI system.

_Note: When we refer to UUID - they specifically are in this format:_<br>
[UUID format: "728ff542-b332-4520-bb2e-51d5e32cfc0a"](https://en.wikipedia.org/wiki/Universally_unique_identifier)

_Kafka Topics_...<br>
**BAI_APP_BFF, BAI_APP_FETCHER, BAI_APP_EXECUTOR**<br>
**BAI_SYS_BFF, BAI_SYS_FETCHER, BAI_SYS_EXECUTOR**<br>
**CMD_SUBMIT**,<br>
**CMD_RETURN, BAI_APP_STATUS**<br>

#### Key attributes:

* “**action-id**” _remains the same_ throughout the transformations of the events.  It represents the client's semantic action, despite how we accomplish it.
* “**message-id**” is always unique and set for **every** dispatch of the message.
* "**tstamp**" is in **millis** since epoch and are set the the time when a message **arrives**.
   (The date field should be identical to the tstamp of the last visited node)
* "**visited**" contains the set of services that have transformed the event in some way - the event's provenance.
* **BAI_APP_STATUS** and **CMD_RETURN** we consider as "broadcast" topics a slightly different classification than the other topics which have more directed semantics.
----

TOML → Client Tool (anubis): → BFF via web service call.

(The TOML format is described [here](https://github.com/MXNetEdge/benchmark-ai/tree/master/executor/#example-descriptor))

```
{
    message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    client_version: "0.1.0"
    client_sha : "<sha1>"
    client_username: "vasya"
    date: "1554901873677" //millis epoch when sent from baictl
    visited: [{svc:"baictl", tstamp:"1554901873677" version:"v0.1.0-481dad1"}],
    payload:{
        toml:{
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" //Base64(see https://raw.githubusercontent.com/MXNetEdge/benchmark-ai/master/sample-benchmarks/single-node/descriptor_cpu.toml?token=ABNAFyoEABKZ-1J9XZJet22sFE1Uuc1iks5ctyuDwA%3D%3D)
        }
    },
}
```
----

[below]<br>
Sent from BFF directly (...to Fetcher) via the Kafka topic **BAI_APP_BFF**<br>
**BFF**: [ingress]: (The Client Tool) → [egress]: **BAI_APP_BFF**

```
{
 -> message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
 -> action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "0.1.0"
    client_username: "vasya"
 -> authenticated: "true"
    date: "1554901873677" //millis epoch
 -> visited: [{svc:"anubis-client", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:null },
              {svc:"bai-bff", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"bai-bff-045" }],
    type: "BAI_APP_BFF"
    payload:{
 ->     datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll"}
            ],
        scripts: [
            {dst: "s3://<bucket>/anubis0/<scriptfile>.tar" }
            ]
        toml:{
 ->         contents: { ... }
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64
        }
    },
}
```
----

[below]<br>
Sent from Fetcher (...to Executor) via the Kafka topic:<br>
**Fetcher**: [ingress]:  **BAI_APP_BFF** → [egress]:  **BAI_APP_FETCHER**

```
{
 -> message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "1.0"
    client_username: "vasya"
    authenticated: "true"
    date: "1554901873677" //millis epoch
    visited: [{svc:"anubis-client", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"null"},
              {svc:"bai-bff", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"bai-bff-045"},
 ->           {svc:"fetcher-dispatcher",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"fetcher-dispatcher-045"}],
    type: "BAI_APP_FETCHER"
    payload:{
        datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
 ->          dst:"s3://mycache/datasets/20429402904290"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
 ->          dst:""} //Missing for whatever reason...
            ],
        toml:{
            contents: {...}
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64
        }
    },
}
```
----

[below]<br>
Sent from Executor ... This may be what we would consider the “receipt” for the submission, perhaps augmented further with information on where to look to get the graphs / dashboard for the run.<br>
**Executor**: [ingress]:  **BAI_APP_FETCHER** →  [egress]:  **BAI_APP_EXECUTOR**

```
{
 -> message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "1.0"
    client_username: "vasya"
    authenticated: "true"
    date: "1554901873677" //millis epoch
    visited: [{svc:"anubis-client", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:null},
              {svc:"bai-bff", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"bai-bff-045"},
              {svc:"fetcher-dispatcher",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"fetcher-dispatcher-045"},
 ->           {svc:"executor",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"executor-045fr"}],
    type: "BAI_APP_EXECUTOR"
    payload:{
 ->     job: {
 ->         id: "<kubernetes label>"
 ->         namespace: "bai-user"
 ->         k8s_yaml: "<document contents>"
 ->         output: "<output information string>"
        },
        datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudidokiudfdfklfdjll",
             dst:"s3://mycache/datasets/20429402904290",
             status="SUCCESS"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
             dst:"",
            ],
        toml:{
            contents: { ... }
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64 encoded
        }
    },
}
```

The job is run and the output and status are updated in a new message that contains the result of the run.
This means that the executor will also push to the **BAI_APP_EXECUTOR** channel with an update of the message.

----

## Broadcast Topics

System topic: **BAI_APP_STATUS**

(From any service that wants to report status about a customer's “action”)

```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
  client_version: "1.0" //     (optional)
  client_username: "vasya" //  (optional)
  authenticated: "true" //     (optional)
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1"}],
  type: "BAI_APP_STATUS"
  message: "Invalid digest|404|501 and failed to get|Timeout"
  status: [ SUBMITTED | ERROR | INITIALIZING | RUNNING | FAILED | SUCCEEDED | ...],
  payload:{
    ...
  },
}
```

System topic: **CMD_SUBMIT**


```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //Not the same as action_id_to_delete
  client_version : "0.1.0"
 ?client_sha : "<sha1>"
  client_username: "vasya"
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"example-node-1"}],
  type: "CMD_SUBMIT"
  payload:{
    command: "cancel"
    args:{**target_action_id:**"<UUID>", ...} //the action that this command will operate on
  },
}
```


System topic: **CMD_RETURN**

```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //semantically identifies this action (carried around throughout message life)
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"example-node-1"}],
  type: "CMD_RETURN"
  message: "" // Intended for the user to see
  payload:{
    return_code: <NUMBER> // Unix-like: 0 for SUCCESS, else failure
    return_value: {} // Actual output of the command
    cmd_submit: <FULL_CMD_SUBMIT_EVENT>
  },
}
```
