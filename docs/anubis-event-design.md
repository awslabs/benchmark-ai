# Benchmark AI: Event design

https://quip-amazon.com/JGHsAukyNFOs/BenchmarkAI-Descriptor-file

This document describes each of the main events that are pushed through the Benchmark AI system.

#---------<br>
EVERY event must have...<br>
#---------<br>

UUID = UUID created from the initial ingress point of the system
CLIENT_VERSION = The version of the client
API_VERSION = The version of the API that this client is speaking
CLIENT_USER = The username of the client
AUTHENTICATED = Whether or not this client has been authenticated.
DATE = The date created (to nanosecond)
VISITED = array of ids of nodes visited

[UUID format: "728ff542-b332-4520-bb2e-51d5e32cfc0a"](https://en.wikipedia.org/wiki/Universally_unique_identifier)

_Kafka Topics_...<br>
**BAI_APP_BFF, BAI_APP_FETCHER, BAI_APP_EXECUTOR**<br>
**BAI_SYS_BFF, BAI_SYS_FETCHER, BAI_SYS_EXECUTOR**<br>
**CMD_SUBMIT**,<br>
**CMD_RETURN, BAI_APP_STATUS**<br>

#### Notes:

* “**action-id**” _remains the same_ throughout the transformations of the events.  It represents the client's semantic action, despite how we accomplish it.
* “**message-id**” is always unique and set for **every** dispatch of the message.
* "**tstamp**" is in **millis** since epoch and are set the the time when a message **arrives**.
   (The date field should be identical to the tstamp of the last visited node)
* **BAI_APP_STATUS** and **CMD_RETURN** we consider as "broadcast" topics a slightly different classification than the other topics which have more directed semantics.
----

Client Tool (baictl): → BFF via web service call.

(The TOML format is described [here](https://github.com/MXNetEdge/benchmark-ai/tree/master/baictl/descriptor-file))

```
{
    message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    client_version: "0.1.0"
    client_sha : "<sha1>"
    client_username: "vasya"
    date: "1554901873677" //millis epoch when sent from baictl
    visited: [{svc:"baictl", tstamp:"1554901873677" version:"v0.1.0-481dad1"}],
    payload:{
        toml:{
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" //Base64(see https://raw.githubusercontent.com/MXNetEdge/benchmark-ai/master/sample-benchmarks/single-node/descriptor_cpu.toml?token=ABNAFyoEABKZ-1J9XZJet22sFE1Uuc1iks5ctyuDwA%3D%3D)
        }
    },
}
```
----

[below] Sent from BFF directly (...to Fetcher) via the Kafka topic **BAI_APP_BFF**
**BFF**: [ingress]: (The Client Tool) → [egress]: **BAI_APP_BFF**

```
{
 -> message_id**: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
 -> **action_id**:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "0.1.0"
    client_username: "vasya"
 -> authenticated: "true"
    date: "1554901873677" //millis epoch
 -> visited: [{svc:"baictl", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"baictl-client-1"},
              {svc:"frontend-02", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"baictl-bff-045" }],
**    type: "BAI_APP_BFF"
**    payload:{
 ->     datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll"}
            ],
        scripts: [
            {dst: "s3://<bucket>/anubis0/<scriptfile>.tar" }
            ]
        toml:{
 ->         contents: { ... }
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64
        }
    },
}
```
----

[below] Sent from Fetcher (...to Executor) via the Kafka topic:
**Fetcher**: [ingress]:  **BAI_APP_BFF** → [egress]:  **BAI_APP_FETCHER**

```
{
 -> message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "1.0"
    client_username: "vasya"
    authenticated: "true"
    date: "1554901873677" //millis epoch
    visited: [{svc:"baictl", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"baictl-client-1"},
              {svc:"frontend-02", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"baictl-bff-045"},
 ->           {svc:"fetcher-01",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"fetcher-node-045"}],
    type: "BAI_APP_FETCHER"
    payload:{
        datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
 ->          dst:"s3://mycache/datasets/20429402904290"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
 ->          dst:""} //Missing for whatever reason...
            ],
        toml:{
            contents: {...}
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64
        }
    },
}
```
----

[below] Sent from Executor ... This may be what we would consider the “receipt” for the submission, perhaps augmented further with information on where to look to get the graphs / dashboard for the run.
**Executor**: [ingress]:  **BAI_APP_FETCHER → **[egress]:  **BAI_APP_EXECUTOR**

```
{
 -> message_id: "<UUID>" //As generated by bff to prevent issues with non-conformant client
    client_id:  "<UUID>" //a constant value that will always represent this client & user combo
    action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
    client_version: "1.0"
    client_username: "vasya"
    authenticated: "true"
    date: "1554901873677" //millis epoch
    visited: [{svc:"baictl", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"baictl-client-1"},
              {svc:"frontend-02", tstamp:"1554901873677", version:"v0.1.0-7bf8717", node:"baictl-bff-045"},
              {svc:"fetcher-01",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"fetcher-node-045"},
 ->           {svc:"executor-01",  tstamp:"1554901873679", version:"v0.1.0-3ed8215", node:"executor-node-045fr"}],
    type: "BAI_APP_EXECUTOR"
    payload:{
 ->     job: {
 ->         id: "<kubernetes label>"
 ->         namespace: "bai-user"
 ->         k8s_yaml: "<document contents>"
 ->         output: "<output information string>"
        },
        datasets: [
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudidokiudfdfklfdjll",
             dst:"s3://mycache/datasets/20429402904290",
             status="SUCCESS"},
            {src:"http://imagenet.org/somebig.zig",
             md5: "gifudifdoiudfdfklfdjll",
             dst:"",
            ],
        toml:{
            contents: { ... }
            descriptor_filename="descriptor_cpu.toml"
            sha1:d99cf00af3e9019f4fe7b180c47ef047395d2067
            doc: "Initial toml" // Base64 encoded
        }
    },
}
```

The job is run and the output and status are updated in a new message that contains the result of the run.
This means that the executor will also push to the **BAI_APP_EXECUTOR** channel with an update of the message.

----

System topic: **BAI_APP_STATUS**

(From any service that wants to report status about a customer's “action”)

```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //semantically identified this action (carried around throughout message life)
  client_version: "1.0" //     (optional)
  client_username: "vasya" //  (optional)
  authenticated: "true" //     (optional)
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1"}],
  type: "BAI_APP_STATUS"
  message: "Invalid digest|404|501 and failed to get|Timeout"
  status: [ SUBMITTED | ERROR | INITIALIZING | RUNNING | FAILED | SUCCEEDED | ...],
  payload:{
    ...
  },
}
```

System topic: **CMD_SUBMIT**


```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //Not the same as action_id_to_delete
  client_version : "0.1.0"
 ?client_sha : "<sha1>"
  client_username: "vasya"
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"example-node-1"}],
  type: "CMD_SUBMIT"
  payload:{
    command: "cancel"
    args:{**target_action_id:**"<UUID>", ...} //the action that this command will operate on
  },
}
```


System topic: **CMD_RETURN**

```
{
  message_id: "<UUID>"
  client_id:  "<UUID>"
  action_id:  "<UUID>" //semantically identifies this action (carried around throughout message life)
  date: "1554901873677" //millis epoch
  visited: [{svc:"fetcher", tstamp:"1554901873677", version:"v0.1.0-481dad1", node:"example-node-1"}],
  type: "CMD_RETURN"
  payload:{
    return_code: <NUMBER> // Unix-like: 0 for SUCCESS, else failure
    return_value: {} // Actual output of the command
    message: "" // Intended for the user to see
    cmd_submit: <FULL_CMD_SUBMIT_EVENT>
  },
}
```
